# Implementation Plan: Database & Location Infrastructure

**Branch**: `001-database-location-foundation` | **Date**: 2025-10-31 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-database-location-foundation/spec.md`

**Note**: This plan is generated by the `/speckit.plan` command.

## Summary

Build the foundational data persistence and location tracking infrastructure for the Redlights bike computer app. This includes a Room database with 4 core entities (Ride, RidePoint, Stop, StopCluster), high-accuracy GPS tracking at 1-second intervals, and a foreground service for reliable background location tracking. All ride data must survive app crashes and persist across sessions with sub-second query performance.

## Technical Context

**Language/Version**: Kotlin 1.9+ with JVM target 11
**Primary Dependencies**:
- Room 2.6+ (database abstraction + SQLite)
- Hilt 2.48+ (dependency injection)
- Google Play Services Location 21.0+ (FusedLocationProviderClient)
- Kotlinx Coroutines 1.7+ (async operations)
- Jetpack Compose (UI framework - used by other features)

**Storage**: Room database (SQLite) with 4 tables, targeting <5MB per 2-hour ride
**Testing**: Manual testing for v1.0 (unit tests deferred to v1.1+)
**Target Platform**: Android 12+ (API 31+), phone/tablet devices with GPS
**Project Type**: Mobile (Android)
**Performance Goals**:
- Location updates: 1Hz (1 per second) with <5% jitter
- Query performance: <1s for ride list, <2s for single ride with all data
- Database writes: Non-blocking, background thread execution
- Battery consumption: <10% per hour of active tracking

**Constraints**:
- Foreground service required for background location tracking (Android 12+ restrictions)
- GPS accuracy filtering: reject updates >50m accuracy
- Smart sampling: Store only significant position changes (not every GPS update)
- No network required: Pure offline operation
- Must handle app crashes gracefully (discard incomplete rides)
- Storage efficiency: 500+ rides supported before cleanup needed

**Scale/Scope**:
- Single active ride at a time
- 50-7200 GPS points per ride after sampling (1-2 hour rides)
- 3-20 stops per typical ride
- Unlimited stop clusters accumulate over app lifetime
- Support 500+ historical rides in database

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: ✅ PASS (No project constitution defined yet)

**Notes**: The `.specify/memory/constitution.md` is currently a template without project-specific principles. As this is the first feature being implemented, we'll establish constitution principles as patterns emerge during development.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
app/src/main/java/com/tiarkaerell/redlights/
├── data/                           # Data layer
│   ├── local/                      # Local data sources
│   │   ├── database/               # Room database
│   │   │   ├── RedlightsDatabase.kt
│   │   │   ├── entities/          # Database entities
│   │   │   │   ├── RideEntity.kt
│   │   │   │   ├── RidePointEntity.kt
│   │   │   │   ├── StopEntity.kt
│   │   │   │   └── StopClusterEntity.kt
│   │   │   └── dao/               # Data Access Objects
│   │   │       ├── RideDao.kt
│   │   │       ├── RidePointDao.kt
│   │   │       ├── StopDao.kt
│   │   │       └── StopClusterDao.kt
│   │   └── location/              # Location tracking
│   │       ├── LocationTracker.kt
│   │       └── LocationTrackerService.kt  # Foreground service
│   └── repository/                # Repository pattern
│       ├── RideRepository.kt
│       └── LocationRepository.kt
│
├── domain/                        # Domain layer (business logic)
│   ├── model/                     # Domain models (clean architecture)
│   │   ├── Ride.kt
│   │   ├── RidePoint.kt
│   │   ├── Stop.kt
│   │   └── StopCluster.kt
│   └── usecase/                   # Use cases
│       ├── StartRideUseCase.kt
│       ├── StopRideUseCase.kt
│       ├── GetRideHistoryUseCase.kt
│       └── clustering/
│           └── ClusterStopsUseCase.kt
│
└── di/                            # Dependency injection
    ├── DatabaseModule.kt          # Room + DAOs
    └── LocationModule.kt          # Location services

app/src/test/                      # Unit tests (v1.1+)
app/src/androidTest/               # Instrumentation tests (v1.1+)
```

**Structure Decision**: Standard Android Clean Architecture with 3 layers:
1. **Data Layer**: Room database entities/DAOs, location services, repositories
2. **Domain Layer**: Business models and use cases (pure Kotlin, no Android deps)
3. **DI Layer**: Hilt modules for dependency injection

Presentation layer (ViewModels, UI) will be added in subsequent features.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| [e.g., 4th project] | [current need] | [why 3 projects insufficient] |
| [e.g., Repository pattern] | [specific problem] | [why direct DB access insufficient] |
